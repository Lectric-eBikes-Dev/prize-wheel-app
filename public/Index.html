<!--
  Carnival Spinning Wheel Game (Google Sites-ready)
  Author: ChatGPT (for Lectric eBikes)
  Version: 1.0 (2025-10-17)

  ✅ Embeddable in Google Sites via <Embed > Insert → Embed → Embed Code
  ✅ Optional Google Apps Script backend for shared persistence & IP-based daily limits
  ✅ Works standalone with localStorage if no backend configured

  HOW TO CONFIGURE
  - Set CONFIG.BACKEND_URL to your published Apps Script web app URL to enable shared history + IP checks.
  - Leave it blank "" to run fully locally (per-browser persistence only).

  CONTENTS
  1) Full HTML markup
  2) Inline CSS for layout, animations, carnival aesthetic, confetti, flashing lights
  3) Inline JS for physics wheel, sound sync, game logic, storage, UI updates, leaderboard
  4) At the end of this file: copy‑pasteable Google Apps Script backend (Sheets) + deployment instructions + SSO notes
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lectric - Prize Wheel</title>
  <style>
    :root{
      --bg:#0e1116; /* deep charcoal */
      --panel:#121722;
      --accent:#2b90ff;
      --accent-2:#00d4ff;
      --text:#eef3fb;
      --muted:#b8c2d1;
      --success:#36d399;
      --danger:#ff6b6b;
      --gold:#F6C453;
      --trophy:#F9D648;
      --border:#1e2532;
    }
    html,body{height:100%;}
    body{
      margin:0; background:radial-gradient(1200px 800px at 20% 10%,#131a26,#0a0d12), var(--bg);
      color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }
    .page{
      max-width:1200px; margin: 0px 25px auto; padding: 5px 0px 5px; display:grid; gap:18px;
      grid-template-columns: 1.1fr 0.9fr;
    }
    @media (max-width: 980px){.page{grid-template-columns:1fr;}}

    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between; padding:8px 0 0;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent); box-shadow:0 0 14px var(--accent)}
    .brand h1{font-size:28px; margin:0; letter-spacing:.5px}

    .top-actions{display:flex; gap:10px; align-items:center}
    .btn{appearance:none; border:1px solid var(--border); background:#0f1520; color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; transition:.2s transform, .2s box-shadow, .2s background;
      box-shadow:0 8px 20px rgba(0,0,0,.25) inset, 0 0 0 0 rgba(0,0,0,0);
    }
    .btn:hover{transform:translateY(-1px); background:#121a2a}
    .btn.primary{background:linear-gradient(180deg,#1c72ff,#1652ff); border-color:#1c52e6; box-shadow:0 6px 18px rgba(28,114,255,.35)}
    .btn.ghost{background:transparent}

    .card{background:linear-gradient(180deg,#0e1420,#0c111a); border:1px solid var(--border); border-radius:18px; padding:14px; box-shadow:0 16px 40px rgba(0,0,0,.35);max-height: 660px;
    overflow: hidden;}
    .split{display:grid; gap:18px; grid-template-columns: 1fr}

    /* Left: wheel + form */
    .stage{display:grid; grid-template-columns: minmax(280px,520px); justify-content:center; gap:14px}
    .form{display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:end}
    .form .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--muted)}
    input[type="text"], select, input[type="number"]{background:#0f1520; border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:10px; outline:none}

    .spin-row{display:flex; gap:10px; align-items:center}
    .hold-hint{font-size:12px; color:var(--muted)}

    /* Wheel canvas wrapper with flapper */
    .wheel-wrap{position:relative; display:grid; place-items:center}
    canvas#wheel{width:100%; height:auto; max-width:520px; aspect-ratio:1/1; background:radial-gradient(circle at 50% 48%, #1b2332 0%, #0e1420 70%, #0b1018 100%); border-radius:50%;}

    /* Circular frame & bolts */
    .bezel{position:absolute; inset:10px; border-radius:50%; pointer-events:none; border:10px solid #1a2230; box-shadow:
      inset 0 0 0 6px #0a0f17,
      0 0 0 2px #202a3b,
      0 0 30px rgba(0,0,0,.6)}
    .bolts{position:absolute; inset:0; pointer-events:none}
    .bolts::before, .bolts::after{content:""; position:absolute; width:10px; height:10px; border-radius:50%; background:#aeb7c7; box-shadow:0 0 0 2px #6a7484 inset, 0 0 10px rgba(255,255,255,.4)}
    .bolts::before{top:8px; left:50%; transform:translateX(-50%)}
    .bolts::after{bottom:8px; left:50%; transform:translateX(-50%)}

    /* Flapper / stopper */
    /*
    .flapper{position:absolute; top:10px; left:50%; transform:translateX(-50%) rotate(180deg); width:0; height:0; border-left:14px solid transparent; border-right:14px solid transparent; border-bottom:28px solid #e6edf8; filter:drop-shadow(0 6px 4px rgba(0,0,0,.45)); z-index:3}
    .flapper::after{content:""; position:absolute; top:24px; left:-14px; width:28px; height:8px; background:#b7c5db; border-radius:0 0 6px 6px}
    */
    .flapper {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%) rotate(180deg);
      width: 0;
      height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 30px solid #e8a942;
      filter: drop-shadow(0 6px 4px rgba(0, 0, 0, .45));
      z-index: 3;
    }
    .flapper::after {
      content: "";
      position: absolute;
      top: 30px;
      left: -14px;
      width: 28px;
      height: 8px;
      background: #1f66ff;
      border-radius: 0 0 6px 6px;
    }
    
    /* Flapper / stopper (points downward toward the wheel) */
    /*
    .flapper{
      position:absolute;
      top:-6px;
      left:50%;
      transform:translateX(-50%);
      width:0; height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-top:28px solid #e6edf8;   /* ▲ tip points down *
      filter:drop-shadow(0 6px 4px rgba(0,0,0,.45));
      z-index:3;
    }
    .flapper::after{
      content:"";
      position:absolute;
      top:-6px; left:-14px;
      width:28px; height:8px;
      background:#b7c5db;
      border-radius:0 0 6px 6px;
    }
    */

    @keyframes flick {
      0%, 100% {
        /* Resting position */
        transform: translateX(-50%) rotate(180deg);
      }
      50% {
        /* "Hit" by a spoke - tilted to the side */
        transform: translateX(-50%) rotate(165deg);
      }
    }

    .flick-animation {
      /* This class applies the keyframe animation */
      animation: flick 0.15s ease-in-out;
    }

    /* Win overlay */
    .overlay {
      position: fixed;
      inset: 0;
      display: grid; /* Keep as grid for place-items */
      display: none;
      place-items: center;
      background: rgba(4, 6, 10, .6);
      backdrop-filter: blur(2px);
      /* Add these properties to hide it initially */
      visibility: hidden;
      opacity: 0;
      transition: opacity .2s, visibility .2s;
      z-index: 9998;
    }
    .overlay.show {
      /* Make it visible on .show */
      display: grid;
      visibility: visible;
      opacity: 1;
    }
    .trophy{width:min(420px,80vw); height:auto}
    /* Make overlays & effects topmost */
    #confetti { z-index: 10000; }
    .flash-border { z-index: 9999; } /* lights above the dim overlay for punch */

    /* Flashing border */
    .flash-border{position:fixed; inset:0; pointer-events:none; border:6px solid transparent; border-radius:18px;}
    .flash-border.active{animation:flash 1.1s linear infinite}
    @keyframes flash{0%,100%{box-shadow:0 0 0 6px rgba(255,255,255,.05), inset 0 0 0 6px rgba(255,255,255,.05)} 50%{box-shadow:0 0 0 6px rgba(255,215,0,.9), 0 0 30px 8px rgba(255,215,0,.6), inset 0 0 0 6px rgba(0,200,255,.7)}}

    /* Right: Activity feed */
    .feed{max-height:460px; overflow:auto; margin-top: 30px;}
    .feed-head{display:flex; gap:10px; align-items:center; justify-content:space-between}
    /* Activity feed rows: Name | Timestamp | Guess | Landed | Win */
    /* Shared grid for header and rows */
    :root { --feed-grid: 1.2fr 1fr .6fr .6fr 48px; }  /* Name | Timestamp | Guess | Landed | Win */

    .feed .entry {
      display: grid;
      grid-template-columns: var(--feed-grid);
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px dashed #243048;
    }

    .feed .entry > div { padding: 0 10px; }
    .feed .entry > div + div { border-left: 1px dashed #243048; }

    .feed .entry.header {
      /* Add these properties to make the header sticky */
      position: sticky;
      top: 0;
      background: var(--panel, #121722); /* Prevents scrolling text from showing through */
      z-index: 10; /* Ensures it stays above the other rows */
      color: var(--muted);
      font-weight: 700;
      font-size: 15px;
      border-bottom: 1px solid #243048;
    }

    .feed .entry .name{font-weight:600}
    .feed .entry .time{color:var(--muted); font-size:12px}
    .trophy-ic{width:20px; height:20px; display:inline-block}

    /* Leaderboard modal */
    dialog#board{width:min(720px,92vw); border:1px solid var(--border); border-radius:16px; background:#0f1520; color:var(--text); padding:0}
    #board::backdrop{background:rgba(0,0,0,.6)}
    .board-head{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border)}
    .table{width:100%; border-collapse:collapse}
    .table th, .table td{padding:10px 12px; border-bottom:1px solid #1a2334; text-align:left}
    .table th{color:#9fb3d1; font-weight:600; font-size:13px}
    .table td{font-size:14px}
    .sort-hint{font-size:12px; color:var(--muted);}

    /* Sound toggle */
    .switch{display:inline-flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)}
    .switch input{appearance:none; width:36px; height:22px; background:#1a2230; border-radius:999px; position:relative; outline:none; transition:.2s}
    .switch input:checked{background:#1c72ff}
    .switch input::after{content:""; position:absolute; top:3px; left:3px; width:16px; height:16px; background:white; border-radius:50%; transition:.2s}
    .switch input:checked::after{left:17px}

    /* Confetti canvas */
    #confetti{position:fixed; inset:0; pointer-events:none}

    .notice{font-size:12px; color:var(--muted)}

    /* And change it to this simpler version */
    #debugIndicator {
      display: none; /* Hidden by default */
      background-color: #e53e3e;
      color: white;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: bold;
      border-radius: 4px;
    }

    #topRightControls {
      position: fixed;
      top: 16px;
      right: 24px;
      z-index: 10000;
      display: flex;
      gap: 16px;
      align-items: center;
    }
  </style>
</head>
<body>
  <div id="topRightControls">
    <label class="switch"><input type="checkbox" id="soundToggle" checked><span>Sound</span></label>
    <div id="debugIndicator">DEBUG MODE: ON</div>
  </div>

  <div class="flash-border" id="flash"></div>
  <canvas id="confetti"></canvas>

  <header class="page" style="grid-template-columns:1fr;">
    <div class="brand">
      <div class="dot"></div>
      <h1>Lectric - Prize Wheel</h1>
    </div>
    <div class="top-actions">
      <!--label class="switch"><input type="checkbox" id="soundToggle" checked><span>Sound</span></label-->
      <!--button class="btn" id="historyBtn">View History</button-->
    </div>
  </header>

  <main class="page">
    <!-- Left column: wheel + controls -->
    <section class="card split">
      <div class="stage">
        <div class="wheel-wrap">
          <div class="flapper" id="flapper" aria-hidden="true"></div>
          <canvas id="wheel" width="900" height="900" aria-label="Prize wheel with 24 segments"></canvas>
          <div class="bezel"></div>
          <div class="bolts"></div>
        </div>

        <form class="form" id="entryForm" autocomplete="off">
          <div class="field">
            <label for="name">Your Name</label>
            <input id="name" name="name" type="text" placeholder="e.g., Alex R." required />
          </div>
          <div class="field">
            <label for="guess">Your Guess (1–24)</label>
            <select id="guess" name="guess" required></select>
          </div>
          <div class="spin-row" style="grid-column:1/-1;">
            <button type="button" id="spinBtn" class="btn primary" aria-pressed="false">SPIN</button>
            <button type="button" id="clearDataBtn" class="btn" style="display:none;">Clear Data</button>
            <span class="hold-hint">Press & hold to power up, release to spin.</span>
          </div>
          <div style="grid-column:1/-1" class="notice" id="limitMsg"></div>
        </form>
      </div>
    </section>

    <!-- Right column: activity feed -->
    <aside class="card">
      <div class="feed-head">
        <h3 style="margin:6px 0 10px">Today's Activity</h3>
        <div>
          <input type="date" id="dayPicker" />
        </div>
      </div>
      <div id="hotCloud" style="display:flex; flex-wrap:wrap; gap:8px; margin:16px 0 18px"></div>
      <!--div class="feed" id="feed">
        <div class="entry" style="font-size:12px; color:var(--muted); font-weight:600;">
          <div>Name</div><div class="time">Timestamp</div><div>Guess</div><div>Landed</div><div>Win</div>
        </div>
      </div-->
      <div class="feed" id="feed"></div>

      <div style="text-align: center; padding-top: 25px; border-top: 1px solid var(--border);">
        <button class="btn primary" id="leaderBtn">View Leaderboard</button>
      </div>
    </aside>
  </main>

  <!-- Winner overlay -->
  <div class="overlay" id="winOverlay" role="dialog" aria-modal="true" aria-label="Winner">
    <div style="position: relative; text-align: center; filter: drop-shadow(0 10px 25px rgba(0,0,0,0.5));">
      <svg viewBox="0 0 100 100" style="width:min(300px, 70vw); height:auto;">
        <defs>
          <linearGradient id="trophyGold" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#FDE047"/>
            <stop offset="100%" stop-color="#FBBF24"/>
          </linearGradient>
          <linearGradient id="trophyBase" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#4B5563"/>
            <stop offset="100%" stop-color="#1F2937"/>
          </linearGradient>
        </defs>
        <path d="M 30 95 H 70 C 72 95, 75 92, 75 90 V 85 H 25 V 90 C 25 92, 28 95, 30 95 Z" fill="#111827"/>
        <rect x="35" y="75" width="30" height="10" rx="2" fill="url(#trophyBase)"/>
        <path d="M 45 75 C 45 70, 55 70, 55 75 V 65 C 60 60, 40 60, 45 65 Z" fill="url(#trophyGold)"/>
        <path d="M 15 20 C 15 5, 85 5, 85 20 V 40 C 85 60, 15 60, 15 40 Z" fill="url(#trophyGold)"/>
        <path d="M 15 35 C -5 35, -5 15, 15 15" stroke="url(#trophyGold)" stroke-width="6" fill="none" stroke-linecap="round"/>
        <path d="M 85 35 C 105 35, 105 15, 85 15" stroke="url(#trophyGold)" stroke-width="6" fill="none" stroke-linecap="round"/>
        <text id="winNumber" x="50" y="38" dominant-baseline="middle" text-anchor="middle" font-family="Inter, sans-serif" font-size="28" font-weight="900" fill="#4A2700">7</text>
      </svg>
      <div style="margin-top: -15px; font-size: 3em; color: white; font-weight: 800; text-shadow: 2px 2px 8px #000;">WINNER</div>
    </div>
  </div>
  <div class="overlay" id="loseOverlay" role="alert" aria-live="polite">
    <div style="text-align:center; padding:24px 32px; background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.45)">
      <div style="font-size:42px; font-weight:900; margin-bottom:6px">Sorry, not a winner this time</div>
      <span style="font-size:16px; color:var(--muted)"></span>
    </div>
  </div>

  <!-- Leaderboard modal -->
  <dialog id="board">
    <div class="board-head">
      <strong>Leaderboard</strong>
      <button class="btn" id="boardClose">Close</button>
    </div>
    <div style="padding:10px 16px 16px">
      <div class="sort-hint">Sorted by total wins (desc), then win %.</div>
      <table class="table" id="boardTable">
        <thead><tr><th>#</th><th>Name</th><th>Total Wins</th><th>Total Spins</th><th>Win %</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </dialog>

  <script>
// =====================
// CONFIGURATION
// =====================
const CONFIG = {
  BACKEND_URL: "/api",
  GAME_KEY: "carnival_wheel_v1",
  SEGMENTS: 24,
  COLORS: ["#0e0f12","#1f66ff","#e9eef7"], // black, blue, white repeating
  BORDER_COLOR: "#dbe7ff",
  TICK_SOUND_GAIN: 0.25,
  DEBUG: true
};

// =====================
// UTILITIES
// =====================
const $ = sel => document.querySelector(sel);
const flapperEl = $('#flapper');
const $$ = sel => Array.from(document.querySelectorAll(sel));
const todayKey = (d = new Date()) => d.toISOString().slice(0,10);
const nowTs = () => new Date().toISOString();
function rng(){ return Math.random(); }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

const Store = {
  get(){ try{ return JSON.parse(localStorage.getItem(CONFIG.GAME_KEY) || "{}"); }catch(e){ return {}; }},
  set(data){ localStorage.setItem(CONFIG.GAME_KEY, JSON.stringify(data)); },
  pushSpin(spin){ const db = Store.get(); db.spins = db.spins||[]; db.spins.push(spin); Store.set(db); },
  allSpins(){ const db = Store.get(); return db.spins||[]; },
};

async function backend(method, path, payload){
  if(!CONFIG.BACKEND_URL) return null;
  const url = CONFIG.BACKEND_URL.replace(/\/$/,"") + path;
  const res = await fetch(url, {method, headers:{"Content-Type":"application/json"}, body: payload?JSON.stringify(payload):undefined});
  if(!res.ok) throw new Error("Backend error " + res.status);
  return await res.json();
}

function fingerprint(){
  const ua = navigator.userAgent||""; const tz = Intl.DateTimeFormat().resolvedOptions().timeZone||"";
  let h = 0; for(let i=0;i<ua.length;i++){ h = ((h<<5)-h)+ua.charCodeAt(i); h|=0 }
  for(let i=0;i<tz.length;i++){ h = ((h<<5)-h)+tz.charCodeAt(i); h|=0 }
  return "fp_"+Math.abs(h);
}

function setupDebugFeatures() {
  if (!CONFIG.DEBUG) return; // Only run in debug mode

  $('#debugIndicator').style.display = 'block';

  const clearBtn = $('#clearDataBtn');
  clearBtn.style.display = 'inline-block'; // Make the button visible

  clearBtn.addEventListener('click', async () => {
    const isConfirmed = confirm('Are you sure you want to clear ALL spin data from the Google Sheet and your browser? This cannot be undone.');

    if (isConfirmed) {
      try {
        console.log('Clearing local storage...');
        localStorage.removeItem(CONFIG.GAME_KEY);

        if (CONFIG.BACKEND_URL) {
          console.log('Clearing backend data...');
          const result = await backend('GET', '/admin/reset');
          alert(`Backend cleared successfully. Removed ${result.cleared} records.`);
        } else {
          alert('Local storage cleared.');
        }

        location.reload(); // Reload the page for a fresh start
      } catch (err) {
        console.error('Failed to clear data:', err);
        alert('An error occurred while trying to clear data. Check the console.');
      }
    }
  });
}

// =====================
// WHEEL RENDERING
// =====================
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const size = canvas.width; // 900
const center = size/2; const radius = center-26;
const SEG = CONFIG.SEGMENTS; const per = (Math.PI*2)/SEG;
const numbers = Array.from({length:SEG}, (_,i)=>i+1);

function drawWheel(angle=0){
  ctx.clearRect(0,0,size,size);
  ctx.save();
  ctx.translate(center, center);
  ctx.rotate(angle);

  for(let i=0;i<SEG;i++){
    const start = i*per; const end = start+per;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius,start,end);
    ctx.closePath();
    ctx.fillStyle = CONFIG.COLORS[i % CONFIG.COLORS.length];
    ctx.fill();

    ctx.strokeStyle = CONFIG.BORDER_COLOR;
    ctx.lineWidth = 3;
    ctx.stroke();

    // divider
    ctx.beginPath();
    ctx.rotate(per);
    ctx.moveTo(0,0);
    ctx.lineTo(radius,0);
    ctx.strokeStyle = "#9fb3d1";
    ctx.lineWidth = 1.5;
    ctx.stroke();
    ctx.rotate(-per);

    // number
    const mid = start + per/2;
    ctx.save();
    ctx.rotate(mid);
    ctx.translate(radius*0.72,0);
    ctx.rotate(Math.PI/2);
    ctx.fillStyle = (i % 3 === 2) ? "#0a0f17" : "#eaf2ff";
    ctx.font = "700 36px Inter, system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(String(numbers[i]),0,0);
    ctx.restore();
  }

  // hub
  ctx.beginPath();
  ctx.fillStyle = "#1a2230";
  ctx.arc(0,0, 54, 0, Math.PI*2);
  ctx.fill();
  ctx.lineWidth = 6; ctx.strokeStyle = "#2a3a54"; ctx.stroke();

  ctx.restore();
}

// =====================
// PHYSICS & INPUT (press/hold)
// =====================
let isHolding=false, holdStart=0, spinActive=false, angle=0, lastFrame=0;
let tickIndex = 0;
let spinPlan = null; // {t0, dur, a0, a1}

function holdPower(){
  if(!isHolding) return 0;
  const ms = Date.now() - holdStart; // cap ~2.5s
  return clamp(ms/2500, 0, 1);
}

function segmentFromAngle(a) {
  // The flapper is at the top, which is 270 degrees or 3*PI/2 radians.
  const flapperAngle = 3 * Math.PI / 2;
  // We need to find what part of the wheel is at the flapper's angle.
  // This is the inverse of the wheel's rotation.
  const effectiveAngle = flapperAngle - a;
  // Normalize the angle to be within the 0 to 2*PI range.
  const normalizedAngle = (effectiveAngle % (Math.PI * 2) + (Math.PI * 2)) % (Math.PI * 2);
  // Calculate the segment index based on the angle per segment.
  const segIndex = Math.floor(normalizedAngle / per);
  return segIndex; // Returns 0-23, which corresponds to numbers 1-24.
}

// =====================
// AUDIO (clack)
// =====================
let audioCtx = null; let soundOn = true;
function initAudio(){ if(audioCtx) return; audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
/*function clack(){
  if(!soundOn || !audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'square';
  o.frequency.setValueAtTime(700, audioCtx.currentTime); // lowered pitch
  g.gain.value = CONFIG.TICK_SOUND_GAIN;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.02);
}*/
// The new, improved function
function clack() {
  if (!soundOn || !audioCtx) return;

  const now = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();

  // Connect the nodes
  o.connect(g).connect(audioCtx.destination);

  // Use a 'triangle' wave for a softer, less digital sound
  o.type = 'triangle'; 
  
  // Lower the frequency for a deeper "ticking" pitch
  o.frequency.setValueAtTime(350, now); 

  // Create a sharp "tick" by starting the volume high and fading it out instantly
  g.gain.setValueAtTime(CONFIG.TICK_SOUND_GAIN, now);
  g.gain.linearRampToValueAtTime(0.0001, now + 0.1); // Fade out over 0.1 seconds

  // Start and stop the sound
  o.start(now);
  o.stop(now + 0.1);
}

// =====================
// CONFETTI
// =====================
const confettiCanvas = document.getElementById('confetti');
const cctx = confettiCanvas.getContext('2d');
function resizeConfetti(){ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; }
addEventListener('resize', resizeConfetti); resizeConfetti();
let confetti = [];
function burst(){
  confetti = [];
  const count = 200;
  // Define a color palette
  const colors = ['#FBBF24', '#3B82F6', '#EC4899', '#EF4444', '#8B5CF6', '#10B981'];
  for(let i=0;i<count;i++){
    confetti.push({
      x: Math.random()*innerWidth,
      y: -20 - Math.random()*40,
      vx: (Math.random()-0.5)*2,
      vy: 2 + Math.random()*3,
      r: 3 + Math.random()*4,
      rot: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.2,
      // Add a color property
      color: colors[Math.floor(Math.random() * colors.length)]
    });
  }
}
function drawConfetti(){
  cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  confetti.forEach(p=>{
    p.x += p.vx; p.y += p.vy; p.rot += p.vr; p.vy += 0.02;
    // Use the particle's color
    cctx.fillStyle = p.color;
    cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.rot);
    cctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
    cctx.restore();
  });
  confetti = confetti.filter(p=>p.y < innerHeight+30);
  requestAnimationFrame(drawConfetti);
}
requestAnimationFrame(drawConfetti);

// =====================
// GAME LOOP
// =====================

function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

function animate(t){
  requestAnimationFrame(animate);
  const dt = lastFrame ? (t - lastFrame)/1000 : 0; lastFrame = t;

  if(isHolding && !spinActive){
    angle += 0.002 * Math.sin(t/90);
    drawWheel(angle);
    return;
  }

  if(spinActive && spinPlan){
    const {t0, dur, a0, a1} = spinPlan;
    const p = Math.min(1, (t - t0) / dur);
    const eased = easeOutCubic(p);
    angle = a0 + (a1 - a0) * eased;

    const seg = segmentFromAngle(angle);
    if(seg !== tickIndex){ 
      tickIndex = seg; 
      clack(); 

      // Add this code to trigger the flapper animation
      flapperEl.classList.add('flick-animation');
      setTimeout(() => {
        flapperEl.classList.remove('flick-animation');
      }, 150); // Duration must match the animation's length
    }

    drawWheel(angle);

    if(p >= 1){
      spinActive = false;
      spinPlan = null;
      onSpinStop();
      endThunk();
    }
  } else {
    drawWheel(angle);
  }
}

requestAnimationFrame(animate);

// =====================
// INPUT BINDINGS
// =====================
const spinBtn = document.getElementById('spinBtn');
function onHoldStart(){ if(spinActive) return; isHolding=true; holdStart=Date.now(); spinBtn.setAttribute('aria-pressed','true'); initAudio(); }
function onHoldEnd(){ if(!isHolding||spinActive) return; isHolding=false; spinBtn.setAttribute('aria-pressed','false'); startSpin(); }
spinBtn.addEventListener('mousedown', onHoldStart); document.addEventListener('mouseup', onHoldEnd);
spinBtn.addEventListener('touchstart', e=>{e.preventDefault(); onHoldStart();}, {passive:false});
document.addEventListener('touchend', e=>{e.preventDefault(); onHoldEnd();}, {passive:false});

// =====================
// SPIN START/STOP + LOGIC
// =====================
let pendingResult = null;

function startSpin(){
  if(spinActive) return;
  const nm = $('#name').value.trim();
  const guess = Number($('#guess').value);
  if(!nm || !guess) return alert('Please enter your name and guess.');

  limitCheck(nm).then(already=>{
    if(already){ showLimitMessage(already); return; }

    const power = holdPower();          // 0..1 (≈ hold 0–2.5s)
    const turns = 3 + Math.floor(Math.random()*3); // 3..5 full revs
    const randOffset = Math.random() * Math.PI * 2;
    const dur = 3000 + 3000*power;      // 3–6 seconds
    spinPlan = {
      t0: performance.now(),
      dur,
      a0: angle,
      a1: angle + (Math.PI*2*turns) + randOffset
    };
    spinActive = true;
    tickIndex = segmentFromAngle(angle);
    pendingResult = { name: nm, guess };
  }).catch(err=>{
    console.error(err); alert('Network error. Try again.');
  });
}


function onSpinStop(){
  const nm = pendingResult.name; const guess = pendingResult.guess;
  const segIndex = segmentFromAngle(angle); // 0-based
  const landed = (segIndex + 1); // 1..24
  const win = (landed === guess);

  const record = {
    name: nm,
    guess,
    landed,
    win,
    ts: nowTs(),
    day: todayKey(),
    fp: fingerprint()
  };

  Store.pushSpin(record);

  if(CONFIG.BACKEND_URL){
    backend('POST','/spins', record).catch(e=>console.warn('Backend save failed', e));
  }

  updateFeed();
  if(win){
    celebrate(landed);
  } else {
    showLossOverlay(`Try again tomorrow — landed on ${landed}.`);
    $('#limitMsg').textContent = `Sorry, try again tomorrow. (Landed on ${landed})`;
  }

  pendingResult = null;
}

// =====================
// CELEBRATION & END FEEDBACK
// =====================
function hideOverlays(){
  $('#winOverlay').classList.remove('show');
  $('#loseOverlay').classList.remove('show');
  $('#flash').classList.remove('active');
}

function celebrate(num){
  hideOverlays();  // <-- make sure nothing else is visible
  $('#winNumber').textContent = String(num);
  $('#winOverlay').classList.add('show');
  $('#flash').classList.add('active');
  burst();
  setTimeout(()=>{
    $('#winOverlay').classList.remove('show');
    $('#flash').classList.remove('active');
  }, 4000);
}
function endThunk(){
  if(!soundOn || !audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'triangle';
  o.frequency.setValueAtTime(280, audioCtx.currentTime);
  g.gain.value = CONFIG.TICK_SOUND_GAIN * 0.8;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.08);
}
function showLossOverlay(msg){
  hideOverlays();  // <-- ensure win overlay isn't peeking
  const el = $('#loseOverlay');
  el.querySelector('span').textContent = msg;
  el.classList.add('show');
  setTimeout(()=> el.classList.remove('show'), 4000);
}

// =====================
// DAILY LIMITS
// =====================
async function limitCheck(name){
  if (CONFIG.DEBUG) return null; // Add this line to bypass the check in debug mode

  const day = todayKey();
  const local = Store.allSpins().find(s=>s.day===day && (s.name.toLowerCase()===name.toLowerCase()));
  if(local){ return local; }
  if(!CONFIG.BACKEND_URL) return null;

  try{
    const res = await backend('POST','/check', {name});
    return res && res.already ? res.record : null;
  }catch(e){ console.warn(e); return null; }
}
function showLimitMessage(rec){
  $('#limitMsg').innerHTML = `You already spun today at <strong>${new Date(rec.ts).toLocaleTimeString()}</strong>. Result: <strong>${rec.landed}</strong> (your guess: ${rec.guess}).`;
}

// =====================
// FEED + HISTORY
// =====================
function renderEntry(s){
  const row = document.createElement('div'); row.className='entry';
  const name = div('name', s.name || '');
  const time = div('time', new Date(s.ts).toLocaleString());
  const guess = div('', String(s.guess ?? ''));
  const landed = div('', String(s.landed ?? ''));
  const icon = document.createElement('div'); icon.innerHTML = s.win ? TROPHY_SVG_20 : '';
  [name,time,guess,landed,icon].forEach(n => row.appendChild(n));
  return row;
}
function renderHeader(){
  const h = document.createElement('div'); h.className='entry header';
  ['Name','Timestamp','Guess','Landed','Win'].forEach(txt=>{
    const d=document.createElement('div'); d.textContent=txt; h.appendChild(d);
  });
  return h;
}
function div(cls, text){ const d=document.createElement('div'); if(cls) d.className=cls; d.textContent=text; return d; }

async function fetchAll(){
  if(CONFIG.BACKEND_URL){
    try{ return await backend('GET','/spins'); }catch(e){ console.warn('Backend fetch failed', e); }
  }
  return Store.allSpins();
}

async function updateFeed(){
  const daySel = $('#dayPicker').value || todayKey();
  const all = await fetchAll();
  const list = all.filter(s=>s.day===daySel).sort((a,b)=>new Date(b.ts)-new Date(a.ts));

  const feed = $('#feed');
  feed.textContent = '';              // rebuild from scratch
  feed.appendChild(renderHeader());   // header first

  if(!list.length){
    const msg = document.createElement('div'); msg.className='notice'; msg.style.padding='8px 0';
    msg.textContent = `No spins for ${daySel} yet.`; feed.appendChild(msg);
    $('#hotCloud').innerHTML='';
    return;
  }

  list.forEach(s=> feed.appendChild(renderEntry(s)));
  renderHotCloud(list);
}

// =====================
// LEADERBOARD & HOT NUMBERS
// =====================
function computeBoard(spins){
  const map = new Map();
  spins.forEach(s=>{
    if(!map.has(s.name)) map.set(s.name,{name:s.name, wins:0, spins:0});
    const v = map.get(s.name); v.spins++; if(s.win) v.wins++;
  });
  const rows = [...map.values()].map(r=>({...r, pct: r.spins? (r.wins/r.spins*100):0}));
  rows.sort((a,b)=> b.wins - a.wins || b.pct - a.pct || a.name.localeCompare(b.name));
  return rows;
}
function freqByLanded(spins){
  const map = new Map();
  for(let i=1;i<=SEG;i++) map.set(i,0);
  spins.forEach(s=> map.set(s.landed, (map.get(s.landed)||0)+1));
  return map;
}
function renderHotCloud(spinsForDay){
  const cloud = $('#hotCloud'); cloud.innerHTML='';
  const freq = freqByLanded(spinsForDay);
  const max = Math.max(1, ...freq.values());
  freq.forEach((count,num)=>{
    if(count===0) return; // show only numbers that hit today
    const b = document.createElement('div');
    const scale = 0.8 + (count/max)*1.2; // 0.8x–2.0x
    b.textContent = num;
    b.style.fontWeight = 800;
    b.style.padding = '4px 8px';
    b.style.borderRadius = '999px';
    b.style.border = '1px solid var(--border)';
    b.style.background = 'linear-gradient(180deg,#142033,#0e1626)';
    b.style.boxShadow = '0 6px 16px rgba(0,0,0,.25)';
    b.style.transform = `scale(${scale.toFixed(2)})`;
    b.title = `${count} spin${count>1?'s':''} today`;
    cloud.appendChild(b);
  });
}
async function openBoard(){
  const all = await fetchAll();
  const rows = computeBoard(all);
  const tbody = $('#boardTable tbody'); tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.wins}</td><td>${r.spins}</td><td>${r.pct.toFixed(1)}%</td>`;
    tbody.appendChild(tr);
  });
  $('#board').showModal();
}

function escapeHtml(str){return str.replace(/[&<>"]+/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s]));}

// =====================
// INIT
// =====================
const guessSel = document.getElementById('guess');
for(let i=1;i<=SEG;i++){ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=String(i); guessSel.appendChild(opt); }

const dpk = document.getElementById('dayPicker');
dpk.value = todayKey();
dpk.addEventListener('change', updateFeed);

document.getElementById('leaderBtn').addEventListener('click', openBoard);
document.getElementById('boardClose').addEventListener('click', ()=>$('#board').close());
//document.getElementById('historyBtn').addEventListener('click', () => { dpk.focus(); });
document.getElementById('soundToggle').addEventListener('change', e=>{ soundOn = e.target.checked; if(soundOn) initAudio(); });

drawWheel(0);
updateFeed();
setupDebugFeatures();

// =====================
// ICONS
// =====================
const TROPHY_SVG_20 = `<svg class="trophy-ic" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path fill="#F6C453" d="M18 7h2V4h-2V2H6v2H4v3h2c.1 2.5 1.6 4.6 3.7 5.3A5 5 0 0 0 7 17v2H5v3h14v-3h-2v-2c0-2-1.3-3.8-3.1-4.7C16.4 11.6 17.9 9.5 18 7Z"/></svg>`;
</script>

</body>
</html>